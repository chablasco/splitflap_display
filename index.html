<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>CB Split-Flap Display</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/1.6.0/p5.js"></script>
  <style>
    body { margin:0; overflow:hidden; background:#000; }
    canvas { display:block; }
  </style>
</head>
<body>
<script>
let rows=1, cols=3, splitFlaps=[];
let speed=0.41, font;

const allowedChars="ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789&";
const WAR_PROB=0.05, WORD_PROB=0.20;

const WORDS=["ACT","LAW","TAX","WAR","VOTE","BAN","UNF","EPA","USA","ICE","SEA","AIR","ASH","OAK","ELM","BEE","ANT","FOX","OWL","NBC","DNA","FCK","DNS","CMD","VCA","VCV","RCA","NBA","WTC","WTF","OMG","PAN","TAN","COS","WAV","ONU","OPN","KLF","JFK","DEA","FBI","IDM","DIE","UFO","LIP","SHT","BOM","DAD","MAN","MEN","MOM","BRO","SIS","LOL","IDK","MAR","ARM","3XL","808","404","VIS","LOF","LOV","C74","Q&A","TNT","WAX","TNP","LYX","LUX","CBM","JBM","ARV","ART","CBD","TNX","ZOO","TNP","DPM","OWN","DAY","LAY","SOV","VOX","VOZ","MAP","42U","KKK","TLC","AGI","RUN","PEN","BOX","TRY","WIN","KEY","CAR","SKY","CAT","DOG","BOY"];

let wordBag = [];

function preload(){ font=loadFont('assets/DelaGothicOne-Regular.ttf'); }

function setup(){
  createCanvas(windowWidth, windowHeight);
  textFont(font);
  refillWordBag();
  initFlaps();
  startNextCycle();
}

function draw(){
  background(0);
  for(let j=0;j<cols;j++){ splitFlaps[j].update(); splitFlaps[j].display(); }
  if(splitFlaps.every(f=>f.ready())) startNextCycle();
}

function startNextCycle(){
  let word;
  const r=random();

  if(r < WAR_PROB){
    word="WAR";
  } else if(r < WAR_PROB + WORD_PROB){
    word = drawFromWordBag();
  } else {
    word = randomWord(cols);
  }

  word = word.toUpperCase().padEnd(cols, " ").slice(0, cols);
  for(let j=0;j<cols;j++) splitFlaps[j].setTarget(word[j]);
}

function drawFromWordBag(){
  if(wordBag.length === 0) refillWordBag();
  return wordBag.pop();
}

function refillWordBag(){
  wordBag = WORDS.slice();
  for(let i=wordBag.length-1;i>0;i--){
    const j = int(random(i+1));
    const tmp = wordBag[i];
    wordBag[i] = wordBag[j];
    wordBag[j] = tmp;
  }
}

function randomWord(n){
  let s="";
  for(let i=0;i<n;i++) s+=allowedChars[int(random(allowedChars.length))];
  return s;
}

function nextChar(ch){
  return allowedChars[(allowedChars.indexOf(ch)+1)%allowedChars.length];
}

class SplitFlap{
  constructor(x,y,w,h,speed,startPos){
    this.x=x; this.y=y; this.w=w; this.h=h; this.speed=speed;
    this.ch=allowedChars[startPos]; this.targetCh=this.ch;
    this.lerpVal=0; this.flipping=false;
    this.pauseUntil=millis()+random(600,1800);
  }
  setTarget(t){ this.targetCh=t; this.flipping=true; this.lerpVal=0; }
  ready(){ return !this.flipping && millis()>=this.pauseUntil; }
  update(){
    if(!this.flipping) return;
    this.lerpVal+=this.speed;
    if(this.lerpVal>=1){
      this.lerpVal=0; this.ch=nextChar(this.ch);
      if(this.ch===this.targetCh){
        this.flipping=false;
        this.pauseUntil=millis()+random(600,3010);
      }
    }
  }
  display(){
    const red = (this.ch==="W"||this.ch==="A"||this.ch==="R");
    fill(red ? color(255,0,0) : 255);
    textSize(min(this.w,this.h)/2);
    textAlign(CENTER,CENTER);
    text(this.ch, this.x+this.w/2, this.y+this.h/2);
  }
}

function initFlaps(){
  splitFlaps=[];

  // Keep the splitflaps centered in the canvas (center/center)
  const flapSize = min(width/cols, height/rows);   // square cells
  const gridW = flapSize * cols;
  const gridH = flapSize * rows;
  const x0 = (width - gridW) / 2;
  const y0 = (height - gridH) / 2;

  for(let j=0;j<cols;j++){
    let startPos=int(random(allowedChars.length));
    splitFlaps[j]=new SplitFlap(
      x0 + j*flapSize,
      y0,
      flapSize,
      flapSize,
      speed,
      startPos
    );
  }
}

function mousePressed(){ fullscreen(!fullscreen()); }
function windowResized(){ resizeCanvas(windowWidth, windowHeight); initFlaps(); startNextCycle(); }
</script>
</body>
</html>
